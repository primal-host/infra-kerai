<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ker.ai</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{overflow:hidden;background:#0d1117;color:#c9d1d9;font-family:'SF Mono','Cascadia Code','Fira Code',monospace;font-size:14px}
body{display:flex;flex-direction:column}
#stack-area{flex:1;overflow-y:auto;padding:12px 0;display:flex;flex-direction:column;justify-content:flex-end}
.stack-empty{color:#484f58;text-align:center;padding:20px;font-style:italic}
.stack-item{display:flex;align-items:flex-start;padding:2px 16px;line-height:1.5}
.stack-item:hover{background:#161b22}
.stack-rowid{color:#484f58;min-width:64px;text-align:right;margin-right:12px;flex-shrink:0;font-size:13px}
.stack-content{flex:1;white-space:pre-wrap;word-break:break-all}
.kind-int,.kind-float{color:#79c0ff}
.kind-text{color:#a5d6ff}
.kind-list{color:#d2a8ff}
.kind-error{color:#f85149}
.kind-library{color:#ffa657}
.kind-workspace_list{color:#7ee787}
.kind-auth_pending{color:#d29922}
.kind-session{color:#58a6ff}
.kind-list-help{color:#8b949e}
.kind-text-info{color:#58a6ff}
.kind-text-warn{color:#d29922}
.kind-text-success{color:#7ee787}
.kind-text-muted{color:#8b949e}
.ws-item{display:block;padding:2px 0;cursor:pointer}
.ws-item:hover{text-decoration:underline}
.ws-active{font-weight:bold}
#input-row{display:flex;align-items:center;padding:4px 16px 8px;border-top:1px solid #21262d;background:#0d1117}
#prompt{color:#58a6ff;margin-right:8px;white-space:nowrap;user-select:none}
#input{flex:1;background:transparent;border:none;outline:none;color:#c9d1d9;font:inherit;caret-color:#58a6ff}
#conn-panel{max-height:0;overflow:hidden;transition:max-height 0.3s ease;background:#161b22;border-top:1px solid #21262d}
#conn-panel.open{max-height:60vh;overflow-y:auto}
#conn-panel-inner{padding:12px 16px}
.conn-host{color:#484f58;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.conn-handle{color:#8b949e;font-size:13px;padding:2px 0 6px 12px}
.conn-ws{display:block;padding:8px 0 8px 24px;color:#c9d1d9;font-size:13px;cursor:pointer;-webkit-tap-highlight-color:transparent;border:none;background:none;font:inherit;width:100%;text-align:left}
.conn-ws:active{opacity:0.7}
.conn-ws.active{color:#7ee787}
.conn-ws-count{color:#484f58;margin-left:4px}
#status{display:flex;justify-content:center;padding:2px 16px;background:#161b22;border-top:1px solid #21262d;font-size:12px;color:#8b949e;user-select:none;cursor:pointer;-webkit-tap-highlight-color:transparent}
#status:active{background:#1c2129}
#status-workspace{display:inline-flex;align-items:center;gap:4px}
.chevron{display:inline-block;font-size:8px;transition:transform 0.3s ease}
.chevron.up{transform:rotate(180deg)}
</style>
</head>
<body>
<div id="stack-area"><div class="stack-empty">empty stack</div></div>
<div id="input-row"><span id="prompt">kerai&gt;</span><input id="input" autofocus autocomplete="off" spellcheck="false"></div>
<div id="conn-panel"><div id="conn-panel-inner"></div></div>
<div id="status"><span id="status-workspace">... <span class="chevron">&#9650;</span></span></div>
<script>
(function(){
function setHeight(){document.body.style.height=window.innerHeight+'px'}
setHeight();
window.addEventListener('resize',setHeight);

const stackArea=document.getElementById('stack-area');
const input=document.getElementById('input');
const statusWorkspace=document.getElementById('status-workspace');
const connPanel=document.getElementById('conn-panel');
const connInner=document.getElementById('conn-panel-inner');
const statusBar=document.getElementById('status');
const chevron=statusWorkspace.querySelector('.chevron');

let session=null;
let history=[];
let histIdx=-1;
let savedInput='';
let panelOpen=false;

// Connections cache with 60s TTL
let connCache={data:null,ts:0};
const CACHE_KEY='kerai_conn_cache';
const CACHE_TTL=60000;

function loadCache(){
  try{
    const raw=localStorage.getItem(CACHE_KEY);
    if(raw){connCache=JSON.parse(raw);}
  }catch(e){}
}
function saveCache(data){
  connCache={data:data,ts:Date.now()};
  try{localStorage.setItem(CACHE_KEY,JSON.stringify(connCache));}catch(e){}
}
function invalidateCache(){
  connCache={data:null,ts:0};
  try{localStorage.removeItem(CACHE_KEY);}catch(e){}
}
loadCache();

// Initialize session
async function initSession(){
  const params=new URLSearchParams(window.location.search);
  const err=params.get('error');
  if(err){
    if(err==='not_allowed'){
      stackArea.innerHTML='<div class="stack-item"><span class="stack-rowid"></span><span class="stack-content kind-error">error: access denied \u2014 your account has not been allowlisted by the admin</span></div>';
    }else{
      stackArea.innerHTML='<div class="stack-item"><span class="stack-rowid"></span><span class="stack-content kind-error">error: '+err+'</span></div>';
    }
    window.history.replaceState({},'','/');
  }
  try{
    const res=await fetch('/auth/session',{credentials:'include'});
    session=await res.json();
    updateStatusBar();
    document.cookie='kerai_session='+session.token+';path=/;max-age=2592000;SameSite=Lax';
  }catch(e){
    statusWorkspace.innerHTML='offline';
  }
}

function updateStatusBar(){
  if(!session)return;
  const name=session.workspace_name||'...';
  statusWorkspace.innerHTML=name+' <span class="chevron'+(panelOpen?' up':'')+'">&#9650;</span>';
}

function renderStack(stack){
  stackArea.innerHTML='';
  if(!stack||stack.length===0){
    stackArea.innerHTML='<div class="stack-empty">empty stack</div>';
    return;
  }
  stack.forEach(function(item){
    const row=document.createElement('div');
    row.className='stack-item';

    const rowid=document.createElement('span');
    rowid.className='stack-rowid';
    rowid.textContent=item.id||'';

    const content=document.createElement('span');
    content.className='stack-content kind-'+item.kind.replace(/\./g,'-');
    content.textContent=formatPtr(item);

    row.appendChild(rowid);
    row.appendChild(content);
    stackArea.appendChild(row);
  });
  stackArea.scrollTop=stackArea.scrollHeight;
}

function formatPtr(ptr){
  if(ptr.meta&&ptr.meta.folded){
    switch(ptr.kind){
      case 'list.help':{
        const count=(ptr.meta.items||[]).length;
        return '[commands: '+count+']';
      }
      case 'workspace_list':{
        const count=(ptr.meta.items||[]).length;
        return '[workspaces: '+count+']';
      }
      case 'text':{
        const s=ptr.ref_id;
        const p=s.length>40?s.slice(0,37)+'...':s;
        return '"'+p+'"';
      }
      default: return ptr.ref_id;
    }
  }
  switch(ptr.kind){
    case 'int': return ptr.ref_id;
    case 'float':{
      const s=ptr.ref_id;
      return s.endsWith('.0')?s.slice(0,-2):s;
    }
    case 'text':{
      const s=ptr.ref_id;
      return s.length>60?'"'+s.slice(0,57)+'..."':'"'+s+'"';
    }
    case 'text.info':
    case 'text.warn':
    case 'text.success':
    case 'text.muted':
      return ptr.ref_id;
    case 'list':{
      try{
        const items=Array.isArray(ptr.meta)?ptr.meta:[];
        const shown=items.slice(0,10).map(formatPtr).join(' ');
        return '['+shown+(items.length>10?'...':'')+']';
      }catch(e){return '[]';}
    }
    case 'workspace_list':{
      const items=(ptr.meta&&ptr.meta.items)||[];
      return 'workspaces:\n'+items.map(function(w,i){
        const mark=w.is_active?' *':'';
        return '  '+(i+1)+'. '+w.name+' ('+w.item_count+' items)'+mark;
      }).join('\n');
    }
    case 'auth_pending':{
      const msg=(ptr.meta&&ptr.meta.message)||'authenticating...';
      return msg;
    }
    case 'session':{
      const handle=(ptr.meta&&ptr.meta.handle)||'anonymous';
      const provider=(ptr.meta&&ptr.meta.provider)||'?';
      return 'session: '+handle+' ('+provider+')';
    }
    case 'list.help':{
      const items=(ptr.meta&&ptr.meta.items)||[];
      if(items.length===0)return 'commands: (none)';
      const ancestors=[];
      const lines=['commands:'];
      items.forEach(function(item){
        const path=item.path, desc=item.desc;
        while(ancestors.length>0){
          const top=ancestors[ancestors.length-1];
          if(path.startsWith(top)&&path.charAt(top.length)==='.') break;
          ancestors.pop();
        }
        const depth=ancestors.length;
        const indent='  '.repeat(depth+1);
        const label=depth>0?'.'+path.slice(path.lastIndexOf('.')+1):path;
        lines.push(indent+label+' \u2014 '+desc);
        ancestors.push(path);
      });
      return lines.join('\n');
    }
    case 'error': return 'error: '+ptr.ref_id;
    case 'library': return '['+ptr.ref_id+']';
    default: return ptr.kind+':'+ptr.ref_id;
  }
}

function renderPanel(data){
  connInner.innerHTML='';
  const host=document.createElement('div');
  host.className='conn-host';
  host.textContent=data.pg_host;
  connInner.appendChild(host);

  const handle=document.createElement('div');
  handle.className='conn-handle';
  handle.textContent=data.handle;
  connInner.appendChild(handle);

  data.workspaces.forEach(function(ws){
    const btn=document.createElement('button');
    btn.className='conn-ws'+(ws.is_active?' active':'');
    btn.innerHTML=ws.name+'<span class="conn-ws-count">('+ws.item_count+')</span>';
    btn.addEventListener('click',function(e){
      e.stopPropagation();
      switchWorkspace(ws.id);
    });
    connInner.appendChild(btn);
  });
}

async function fetchConnections(){
  try{
    const res=await fetch('/api/connections',{credentials:'include'});
    if(!res.ok)return null;
    const data=await res.json();
    saveCache(data);
    return data;
  }catch(e){return null;}
}

async function togglePanel(){
  panelOpen=!panelOpen;
  if(panelOpen){
    connPanel.classList.add('open');
    // Show cached data instantly
    if(connCache.data){
      renderPanel(connCache.data);
    }
    // Fetch fresh data (always, but if cache is fresh skip re-render)
    const fresh=await fetchConnections();
    if(fresh){
      renderPanel(fresh);
    }
  }else{
    connPanel.classList.remove('open');
  }
  updateStatusBar();
}

async function switchWorkspace(wsId){
  if(!session)return;
  try{
    const res=await fetch('/api/workspace/switch',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body:JSON.stringify({workspace_id:wsId,session_token:session.token})
    });
    if(!res.ok)return;
    const data=await res.json();
    renderStack(data.stack);

    // Update session
    session.workspace_name=data.workspace_name;
    session.workspace_id=wsId;

    // Close panel
    panelOpen=false;
    connPanel.classList.remove('open');
    updateStatusBar();
    invalidateCache();
  }catch(e){}
}

async function sendEval(expr){
  if(!session)return;
  try{
    const res=await fetch('/api/eval',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body:JSON.stringify({input:expr,session_token:session.token})
    });
    const data=await res.json();
    renderStack(data.stack);

    // Check for auth_pending â€” redirect to OAuth
    if(data.stack&&data.stack.length>0){
      const last=data.stack[data.stack.length-1];
      if(last.kind==='auth_pending'&&last.meta&&last.meta.url){
        window.location.href=last.meta.url;
        return;
      }
    }

    // Re-fetch session to get updated workspace name
    const sres=await fetch('/auth/session',{credentials:'include'});
    const newSession=await sres.json();
    if(newSession.workspace_name){
      // Update token if changed
      if(newSession.token!==session.token){
        session=newSession;
        document.cookie='kerai_session='+session.token+';path=/;max-age=2592000;SameSite=Lax';
      }else{
        session.workspace_name=newSession.workspace_name;
        session.workspace_id=newSession.workspace_id;
        session.handle=newSession.handle;
      }
      updateStatusBar();
      invalidateCache();
    }
  }catch(e){
    stackArea.innerHTML='<div class="stack-empty">error: network request failed</div>';
  }
}

async function handleSubmit(){
  const raw=input.value;
  input.value='';
  histIdx=-1;
  const trimmed=raw.trim();
  if(!trimmed)return;

  if(history.length===0||history[history.length-1]!==trimmed){
    history.push(trimmed);
  }

  await sendEval(trimmed);
}

input.addEventListener('keydown',function(e){
  if(e.key==='Enter'){
    e.preventDefault();
    handleSubmit();
  }else if(e.key==='ArrowUp'){
    e.preventDefault();
    if(history.length===0)return;
    if(histIdx===-1){
      savedInput=input.value;
      histIdx=history.length-1;
    }else if(histIdx>0){
      histIdx--;
    }
    input.value=history[histIdx];
  }else if(e.key==='ArrowDown'){
    e.preventDefault();
    if(histIdx===-1)return;
    if(histIdx<history.length-1){
      histIdx++;
      input.value=history[histIdx];
    }else{
      histIdx=-1;
      input.value=savedInput;
    }
  }else if(e.key==='l'&&e.ctrlKey){
    e.preventDefault();
    stackArea.innerHTML='<div class="stack-empty">empty stack</div>';
  }else if(e.key==='Escape'&&panelOpen){
    e.preventDefault();
    panelOpen=false;
    connPanel.classList.remove('open');
    updateStatusBar();
  }
});

statusBar.addEventListener('click',function(e){
  e.stopPropagation();
  togglePanel();
});

document.addEventListener('click',function(e){
  if(panelOpen){
    // Close panel if clicking outside it and status bar
    if(!connPanel.contains(e.target)&&!statusBar.contains(e.target)){
      panelOpen=false;
      connPanel.classList.remove('open');
      updateStatusBar();
    }
    return;
  }
  input.focus();
});

initSession();
})();
</script>
</body>
</html>
